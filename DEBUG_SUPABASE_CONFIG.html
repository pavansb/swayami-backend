<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Configuration Debug</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            background: #9650D4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #8547C4;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            color: #dc3545;
        }
        .success {
            color: #28a745;
        }
        .warning {
            color: #ffc107;
        }
        .info {
            color: #17a2b8;
        }
    </style>
</head>
<body>
    <h1>üîß Supabase Configuration Debug Tool</h1>
    <p>This tool helps debug authentication issues by testing Supabase configuration and auth flow independently.</p>

    <div class="section">
        <h2>üìã Configuration Test</h2>
        <button class="btn" onclick="testSupabaseConnection()">Test Supabase Connection</button>
        <button class="btn" onclick="checkAuthConfig()">Check Auth Configuration</button>
        <button class="btn" onclick="clearLogs()">Clear Logs</button>
        <div id="configLogs" class="log"></div>
    </div>

    <div class="section">
        <h2>üîê Authentication Test</h2>
        <p><strong>Warning:</strong> This will redirect you to Google OAuth!</p>
        <button class="btn" onclick="testGoogleAuth()">Test Google Authentication</button>
        <button class="btn" onclick="checkCurrentSession()">Check Current Session</button>
        <button class="btn" onclick="signOutTest()">Sign Out</button>
        <div id="authLogs" class="log"></div>
    </div>

    <div class="section">
        <h2>üõ†Ô∏è Database Trigger Test</h2>
        <p>Test if the database trigger is causing issues:</p>
        <button class="btn" onclick="testDatabaseTrigger()">Simulate User Creation</button>
        <div id="dbLogs" class="log"></div>
    </div>

    <script>
        // Configuration - UPDATE THESE WITH YOUR ACTUAL VALUES
        const SUPABASE_URL = 'https://nqpvomjuaszhwfdhnmik.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xcHZvbWp1YXN6aHdmZGhubWlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUxMzk0MzMsImV4cCI6MjA1MDcxNTQzM30.DLaEUC5tMWfqH2t8FiOPxSEr8ZWmFGBq2EfWZcPnO0k';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(message, type = 'info', section = 'config') {
            const logElement = document.getElementById(section + 'Logs');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            const logEntry = `[${timestamp}] ${message}\n`;
            
            const span = document.createElement('span');
            span.className = className;
            span.textContent = logEntry;
            
            logElement.appendChild(span);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('configLogs').innerHTML = '';
            document.getElementById('authLogs').innerHTML = '';
            document.getElementById('dbLogs').innerHTML = '';
        }

        async function testSupabaseConnection() {
            log('üîÑ Testing Supabase connection...', 'info', 'config');
            
            try {
                // Test basic connection
                const { data, error } = await supabase.from('_supabase_migrations').select('version').limit(1);
                
                if (error) {
                    log(`‚ùå Connection failed: ${error.message}`, 'error', 'config');
                } else {
                    log('‚úÖ Supabase connection successful', 'success', 'config');
                    log(`üìã URL: ${SUPABASE_URL}`, 'info', 'config');
                    log(`üîë Anon Key: ${SUPABASE_ANON_KEY.substring(0, 20)}...`, 'info', 'config');
                }
            } catch (error) {
                log(`‚ùå Unexpected error: ${error.message}`, 'error', 'config');
            }
        }

        async function checkAuthConfig() {
            log('üîÑ Checking auth configuration...', 'info', 'config');
            
            try {
                // Check current session
                const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    log(`‚ö†Ô∏è Session check error: ${sessionError.message}`, 'warning', 'config');
                } else {
                    log(`üìã Current session: ${sessionData.session ? 'Active' : 'None'}`, 'info', 'config');
                    if (sessionData.session) {
                        log(`üë§ User: ${sessionData.session.user.email}`, 'info', 'config');
                    }
                }

                // Check auth settings
                const { data: settingsData } = await supabase.auth.getUser();
                log(`üìã Auth settings check completed`, 'info', 'config');

            } catch (error) {
                log(`‚ùå Auth config check failed: ${error.message}`, 'error', 'config');
            }
        }

        async function testGoogleAuth() {
            log('üîÑ Initiating Google OAuth test...', 'info', 'auth');
            
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: `${window.location.origin}/auth/callback`,
                        queryParams: {
                            access_type: 'offline',
                            prompt: 'consent',
                        }
                    }
                });

                if (error) {
                    log(`‚ùå OAuth initiation failed: ${error.message}`, 'error', 'auth');
                    log(`üìã Error details: ${JSON.stringify(error, null, 2)}`, 'error', 'auth');
                    
                    // Check if it's the database trigger error
                    if (error.message.includes('Database error saving new user')) {
                        log('üîß DATABASE TRIGGER ERROR DETECTED!', 'error', 'auth');
                        log('üí° This confirms the Supabase trigger is causing the issue', 'warning', 'auth');
                        log('üõ†Ô∏è Solution: Run the SQL fix in SUPABASE_TRIGGER_FIX.md', 'info', 'auth');
                    }
                } else {
                    log('‚úÖ OAuth initiated successfully - redirecting to Google...', 'success', 'auth');
                    log(`üìã OAuth data: ${JSON.stringify(data, null, 2)}`, 'info', 'auth');
                }
            } catch (error) {
                log(`‚ùå Unexpected OAuth error: ${error.message}`, 'error', 'auth');
            }
        }

        async function checkCurrentSession() {
            log('üîÑ Checking current session...', 'info', 'auth');
            
            try {
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    log(`‚ùå Session check error: ${error.message}`, 'error', 'auth');
                } else if (data.session) {
                    log('‚úÖ Active session found', 'success', 'auth');
                    log(`üë§ User: ${data.session.user.email}`, 'info', 'auth');
                    log(`üÜî User ID: ${data.session.user.id}`, 'info', 'auth');
                    log(`üìÖ Expires: ${new Date(data.session.expires_at * 1000).toLocaleString()}`, 'info', 'auth');
                } else {
                    log('üì≠ No active session', 'warning', 'auth');
                }
            } catch (error) {
                log(`‚ùå Unexpected session error: ${error.message}`, 'error', 'auth');
            }
        }

        async function signOutTest() {
            log('üîÑ Signing out...', 'info', 'auth');
            
            try {
                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    log(`‚ùå Sign out error: ${error.message}`, 'error', 'auth');
                } else {
                    log('‚úÖ Successfully signed out', 'success', 'auth');
                }
            } catch (error) {
                log(`‚ùå Unexpected sign out error: ${error.message}`, 'error', 'auth');
            }
        }

        async function testDatabaseTrigger() {
            log('üîÑ Testing database trigger...', 'info', 'db');
            log('‚ö†Ô∏è This test simulates what happens during user creation', 'warning', 'db');
            
            try {
                // Try to access a table that might trigger the issue
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    log(`‚ùå Database query error: ${error.message}`, 'error', 'db');
                    
                    if (error.message.includes('relation "public.profiles" does not exist')) {
                        log('üîß CONFIRMED: profiles table does not exist!', 'error', 'db');
                        log('üí° This is why the trigger fails during user creation', 'warning', 'db');
                        log('üõ†Ô∏è The trigger tries to insert into a non-existent table', 'info', 'db');
                    }
                } else {
                    log('‚úÖ Database query successful', 'success', 'db');
                    log(`üìã Found ${data?.length || 0} profiles`, 'info', 'db');
                }
            } catch (error) {
                log(`‚ùå Unexpected database error: ${error.message}`, 'error', 'db');
            }
        }

        // Listen for auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            log(`üîî Auth state changed: ${event}`, 'info', 'auth');
            if (session) {
                log(`üë§ Session user: ${session.user.email}`, 'info', 'auth');
            }
        });

        // Auto-run basic tests on page load
        window.addEventListener('load', () => {
            log('üöÄ Supabase Debug Tool loaded', 'info', 'config');
            testSupabaseConnection();
        });
    </script>
</body>
</html> 